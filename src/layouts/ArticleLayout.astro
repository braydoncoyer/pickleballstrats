---
/**
 * ArticleLayout.astro
 *
 * CRITICAL: This layout does NOT use View Transitions (ClientRouter).
 * This is intentional for ad network compatibility.
 *
 * Ad networks (AdSense, Mediavine, AdThrive) expect full page reloads.
 * View Transitions cause scripts to run only once, breaking ad initialization.
 *
 * DO NOT add ClientRouter or ViewTransitions to this layout.
 */
import { Font } from "astro:assets";
import { PUBLIC_GOOGLE_SITE_VERIFICATION } from "astro:env/client";
import {
  PUBLIC_ADSENSE_CLIENT_ID,
  PUBLIC_ADSENSE_SLOT_IN_CONTENT,
} from "astro:env/client";
import { SITE } from "@/config";
import "@/styles/global.css";

// Check if we should show real ads
const isDev = import.meta.env.DEV;
const hasAdSense = Boolean(PUBLIC_ADSENSE_CLIENT_ID);
const showRealAds = !isDev && hasAdSense;

type Props = {
  title?: string;
  author?: string;
  profile?: string;
  description?: string;
  ogImage?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | null;
  scrollSmooth?: boolean;
};

const {
  title = SITE.title,
  author = SITE.author,
  profile = SITE.profile,
  description = SITE.desc,
  ogImage = SITE.ogImage ? `/${SITE.ogImage}` : "/og.png",
  canonicalURL = new URL(Astro.url.pathname, Astro.url),
  pubDatetime,
  modDatetime,
  scrollSmooth = false,
} = Astro.props;

const socialImageURL = new URL(ogImage, Astro.url);

const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: `${title}`,
  image: `${socialImageURL}`,
  datePublished: `${pubDatetime?.toISOString()}`,
  ...(modDatetime && { dateModified: modDatetime.toISOString() }),
  author: [
    {
      "@type": "Person",
      name: `${author}`,
      ...(profile && { url: profile }),
    },
  ],
};
---

<!doctype html>
<html
  dir={SITE.dir}
  lang=`${SITE.lang ?? "en"}`
  class={`${scrollSmooth && "scroll-smooth"}`}
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />

    <!-- Load Font -->
    <Font
      cssVariable="--font-google-sans-code"
      preload={[{ subset: "latin", weight: 400, style: "normal" }]}
    />

    <!-- General Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="author" content={author} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={socialImageURL} />

    <!-- Article Published/Modified time -->
    {
      pubDatetime && (
        <meta
          property="article:published_time"
          content={pubDatetime.toISOString()}
        />
      )
    }
    {
      modDatetime && (
        <meta
          property="article:modified_time"
          content={modDatetime.toISOString()}
        />
      )
    }

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    <!-- Google JSON-LD Structured data -->
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify(structuredData)}
    />

    <!-- Enable RSS feed auto-discovery -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title={SITE.title}
      href={new URL("rss.xml", Astro.site)}
    />

    <meta name="theme-color" content="" />

    {
      PUBLIC_GOOGLE_SITE_VERIFICATION && (
        <meta
          name="google-site-verification"
          content={PUBLIC_GOOGLE_SITE_VERIFICATION}
        />
      )
    }

    <!-- NO ClientRouter/ViewTransitions - ads need full page reloads -->

    <!-- AdSense Script (Production only) -->
    {showRealAds && (
      <script
        async
        src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${PUBLIC_ADSENSE_CLIENT_ID}`}
        crossorigin="anonymous"
      />
    )}

    <!-- Ad placeholder slot for additional ad scripts -->
    <slot name="head-ads" />

    <!-- Minimal inline script to prevent FOUC - sets theme immediately -->
    <script is:inline>
      (function () {
        const initialColorScheme = "";
        const currentTheme = localStorage.getItem("theme");

        function getPreferTheme() {
          if (currentTheme) return currentTheme;
          if (initialColorScheme) return initialColorScheme;
          return window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
        }

        const themeValue = getPreferTheme();
        document.firstElementChild?.setAttribute("data-theme", themeValue);

        window.theme = {
          themeValue: themeValue,
          getTheme: () => window.theme.themeValue,
          setTheme: val => {
            window.theme.themeValue = val;
          },
        };
      })();
    </script>
  </head>
  <body>
    <slot />

    <!-- Load full theme logic -->
    <script src="../scripts/theme.ts"></script>

    <!-- Initialize in-content ads -->
    <script
      is:inline
      data-show-real-ads={showRealAds}
      data-adsense-client={PUBLIC_ADSENSE_CLIENT_ID || ""}
      data-adsense-slot={PUBLIC_ADSENSE_SLOT_IN_CONTENT || ""}
    >
      // Initialize ad slots injected by remark plugin
      (function() {
        const scriptTag = document.currentScript;
        const showRealAds = scriptTag?.dataset.showRealAds === 'true';
        const adsenseClient = scriptTag?.dataset.adsenseClient;
        const adsenseSlot = scriptTag?.dataset.adsenseSlot;

        document.querySelectorAll('.ad-slot').forEach((slot, index) => {
          if (showRealAds && adsenseClient && adsenseSlot) {
            // Render real AdSense ad
            slot.style.cssText = 'margin: 2rem 0; text-align: center;';

            const ins = document.createElement('ins');
            ins.className = 'adsbygoogle';
            ins.style.display = 'block';
            ins.dataset.adClient = adsenseClient;
            ins.dataset.adSlot = adsenseSlot;
            ins.dataset.adFormat = 'auto';
            ins.dataset.fullWidthResponsive = 'true';

            slot.appendChild(ins);
            (window.adsbygoogle = window.adsbygoogle || []).push({});
            slot.setAttribute('data-ad-initialized', 'adsense');
          } else {
            // Render placeholder
            slot.style.cssText = 'margin: 2rem 0; padding: 1.5rem 1rem; background: var(--color-muted, #f3f4f6); opacity: 0.3; border: 1px dashed var(--color-border, #d1d5db); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;';
            slot.innerHTML = `
              <div style="text-align: center; color: var(--color-muted-foreground, #6b7280); opacity: 0.7;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Advertisement</div>
                <div style="font-size: 0.75rem; opacity: 0.6;">In-content ad ${index + 1}</div>
              </div>
            `;
            slot.setAttribute('data-ad-initialized', 'placeholder');
          }
        });
      })();
    </script>
  </body>
</html>
