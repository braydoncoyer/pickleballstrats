---
/**
 * AdUnit.astro
 *
 * Environment-aware ad component:
 * - Development: Shows styled placeholder
 * - Production (no AdSense): Shows styled placeholder
 * - Production (with AdSense): Shows real AdSense ad
 *
 * IMPORTANT: Because Astro does full page loads (no View Transitions on article pages),
 * ad scripts run fresh on each navigation - exactly what ad networks expect.
 *
 * Positions:
 * - horizontal: After title banner (728x90 or responsive)
 * - vertical: Sidebar ad (300x250 or 300x600)
 * - rectangle: After content (336x280)
 * - in-content: Injected between paragraphs via remark plugin
 */
import {
  PUBLIC_ADSENSE_CLIENT_ID,
  PUBLIC_ADSENSE_SLOT_HORIZONTAL,
  PUBLIC_ADSENSE_SLOT_RECTANGLE,
} from "astro:env/client";

type Props = {
  slot?: string;
  position?: "horizontal" | "vertical" | "rectangle" | "in-content";
  className?: string;
};

const { slot, position = "rectangle", className = "" } = Astro.props;

// Check if we should show real ads
const isDev = import.meta.env.DEV;
const hasAdSense = Boolean(PUBLIC_ADSENSE_CLIENT_ID);
const showRealAds = !isDev && hasAdSense;

// Get the appropriate slot ID based on position
const getSlotId = () => {
  switch (position) {
    case "horizontal":
      return PUBLIC_ADSENSE_SLOT_HORIZONTAL || "";
    case "rectangle":
      return PUBLIC_ADSENSE_SLOT_RECTANGLE || "";
    default:
      return slot || "";
  }
};

const adSlotId = getSlotId();

const positionStyles = {
  horizontal: "w-full h-24 max-w-3xl mx-auto",
  vertical: "w-full max-w-[300px] h-[250px] lg:h-[600px]",
  rectangle: "w-full max-w-[336px] h-[280px] mx-auto",
  "in-content": "w-full h-24 my-6",
};

// AdSense format based on position
const adFormat = position === "horizontal" ? "horizontal" : "auto";
---

{showRealAds && adSlotId ? (
  <!-- Real AdSense Ad -->
  <div class:list={["ad-unit", positionStyles[position], className]} data-ad-position={position}>
    <ins
      class="adsbygoogle"
      style="display:block"
      data-ad-client={PUBLIC_ADSENSE_CLIENT_ID}
      data-ad-slot={adSlotId}
      data-ad-format={adFormat}
      data-full-width-responsive="true"
    />
    <script is:inline>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>
) : (
  <!-- Placeholder Ad -->
  <div
    class:list={[
      "ad-unit",
      "bg-muted/30 border border-dashed border-muted-foreground/30",
      "flex items-center justify-center rounded-lg",
      "text-muted-foreground/50 text-sm",
      positionStyles[position],
      className,
    ]}
    data-ad-slot={slot}
    data-ad-position={position}
    data-ad-status="placeholder"
  >
    <div class="text-center">
      <div class="text-xs uppercase tracking-wider mb-1">Advertisement</div>
      <div class="text-xs opacity-60">
        {isDev ? `Dev placeholder - ${position}` : `Ad placeholder - ${position}`}
      </div>
    </div>
  </div>
)}
